
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>Random Forest Classifier &#8212; Corporate Mental Health</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.e7340bb3dbd8dde6db86f25597f54a1b.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Data Modelling" href="models.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Corporate Mental Health</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Corporate Mental Health
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Data Understanding
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../data_understanding/dataset_intro.html">
   Dataset Introduction
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Data Preparation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../data_preparation/data_cleaning.html">
   Data Preparation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data_preparation/select_n_combine_columns.html">
   Data Selection and Segregation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data_preparation/data_preprocessing_2_ce.html">
   Data Preprocessing - 2 - Company Employed
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Data Modelling
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="models.html">
   Data Modelling
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Random Forest Classifier
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/docs/models/rf.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/patilpushkarp/corporate-mental-health"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/patilpushkarp/corporate-mental-health/issues/new?title=Issue%20on%20page%20%2Fdocs/models/rf.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/patilpushkarp/corporate-mental-health/main?urlpath=tree/mh_book/docs/models/rf.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#modelling-company-employees">
   Modelling Company Employees
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#splitting-data">
     Splitting data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-features-encoding">
     Categorical features encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imbalance-check">
     Imbalance check
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-training">
     Model training
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-evaluation">
     Model Evaluation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fairness-evaluation">
     Fairness evaluation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#disparity-check-with-respect-to-gender">
       Disparity check with respect to gender
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mitigated-model-training">
     Mitigated Model Training
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mitigated-model-evaluation">
     Mitigated Model Evaluation
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section id="random-forest-classifier">
<h1>Random Forest Classifier<a class="headerlink" href="#random-forest-classifier" title="Permalink to this headline">¶</a></h1>
<p>We begin our analysis with randomm forest classifer. Random forest is the meta estimator which fits number of decision tree classifiers on various subsamples of data and uses averaging for improving the model accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load required packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">from</span> <span class="nn">fairlearn.metrics</span> <span class="kn">import</span> <span class="n">MetricFrame</span>
<span class="kn">from</span> <span class="nn">fairlearn.reductions</span> <span class="kn">import</span> <span class="n">GridSearch</span><span class="p">,</span> <span class="n">EqualizedOdds</span><span class="p">,</span> <span class="n">TruePositiveRateParity</span>
</pre></div>
</div>
</div>
</div>
<section id="modelling-company-employees">
<h2>Modelling Company Employees<a class="headerlink" href="#modelling-company-employees" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data into dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./../../../datasets/preprocessed_ce.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="splitting-data">
<h3>Splitting data<a class="headerlink" href="#splitting-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tgt_col</span> <span class="o">=</span> <span class="s1">&#39;have you ever sought treatment for a mental health disorder from a mental health professional?&#39;</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">tgt_col</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">tgt_col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check if the data is imbalanced or not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split data into trainining and testing set</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep copy of original variables</span>
<span class="n">X_train_ori</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test_ori</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="categorical-features-encoding">
<h3>Categorical features encoding<a class="headerlink" href="#categorical-features-encoding" title="Permalink to this headline">¶</a></h3>
<p>Before we move forward to encode categorical features, it is necessary to identify them first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1225 entries, 0 to 1224
Data columns (total 55 columns):
 #   Column                                                                                                                                                                                                                          Non-Null Count  Dtype  
---  ------                                                                                                                                                                                                                          --------------  -----  
 0   are you self-employed?                                                                                                                                                                                                          1225 non-null   int64  
 1   how many employees does your company or organization have?                                                                                                                                                                      1225 non-null   object 
 2   is your employer primarily a tech company/organization?                                                                                                                                                                         1225 non-null   float64
 3   is your primary role within your company related to tech/it?                                                                                                                                                                    1225 non-null   float64
 4   does your employer provide mental health benefits as part of healthcare coverage?                                                                                                                                               1225 non-null   object 
 5   do you know the options for mental health care available under your employer-provided health coverage?                                                                                                                          1225 non-null   object 
 6   has your employer ever formally discussed mental health (for example, as part of a wellness campaign or other official communication)?                                                                                          1225 non-null   object 
 7   does your employer offer resources to learn more about mental health disorders and options for seeking help?                                                                                                                    1225 non-null   object 
 8   is your anonymity protected if you choose to take advantage of mental health or substance abuse treatment resources provided by your employer?                                                                                  1225 non-null   object 
 9   if a mental health issue prompted you to request a medical leave from work, how easy or difficult would it be to ask for that leave?                                                                                            1225 non-null   object 
 10  would you feel more comfortable talking to your coworkers about your physical health or your mental health?                                                                                                                     1225 non-null   object 
 11  would you feel comfortable discussing a mental health issue with your direct supervisor(s)?                                                                                                                                     1225 non-null   object 
 12  have you ever discussed your mental health with your employer?                                                                                                                                                                  1225 non-null   float64
 13  would you feel comfortable discussing a mental health issue with your coworkers?                                                                                                                                                1225 non-null   object 
 14  have you ever discussed your mental health with coworkers?                                                                                                                                                                      1225 non-null   float64
 15  have you ever had a coworker discuss their or another coworker&#39;s mental health with you?                                                                                                                                        1225 non-null   float64
 16  overall, how much importance does your employer place on physical health?                                                                                                                                                       1225 non-null   float64
 17  overall, how much importance does your employer place on mental health?                                                                                                                                                         1225 non-null   float64
 18  do you have previous employers?                                                                                                                                                                                                 1225 non-null   int64  
 19  was your employer primarily a tech company/organization?                                                                                                                                                                        1225 non-null   float64
 20  have your previous employers provided mental health benefits?                                                                                                                                                                   1225 non-null   object 
 21  were you aware of the options for mental health care provided by your previous employers?                                                                                                                                       1225 non-null   object 
 22  did your previous employers ever formally discuss mental health (as part of a wellness campaign or other official communication)?                                                                                               1225 non-null   object 
 23  did your previous employers provide resources to learn more about mental health disorders and how to seek help?                                                                                                                 1225 non-null   object 
 24  was your anonymity protected if you chose to take advantage of mental health or substance abuse treatment resources with previous employers?                                                                                    1225 non-null   object 
 25  would you have felt more comfortable talking to your previous employer about your physical health or your mental health?                                                                                                        1225 non-null   object 
 26  would you have been willing to discuss your mental health with your direct supervisor(s)?                                                                                                                                       1225 non-null   object 
 27  did you ever discuss your mental health with your previous employer?                                                                                                                                                            1225 non-null   float64
 28  would you have been willing to discuss your mental health with your coworkers at previous employers?                                                                                                                            1225 non-null   object 
 29  did you ever discuss your mental health with a previous coworker(s)?                                                                                                                                                            1225 non-null   float64
 30  did you ever have a previous coworker discuss their or another coworker&#39;s mental health with you?                                                                                                                               1225 non-null   float64
 31  overall, how much importance did your previous employer place on physical health?                                                                                                                                               1225 non-null   float64
 32  overall, how much importance did your previous employer place on mental health?                                                                                                                                                 1225 non-null   float64
 33  do you currently have a mental health disorder?                                                                                                                                                                                 1225 non-null   object 
 34  have you had a mental health disorder in the past?                                                                                                                                                                              1225 non-null   object 
 35  have you ever sought treatment for a mental health disorder from a mental health professional?                                                                                                                                  1225 non-null   int64  
 36  do you have a family history of mental illness?                                                                                                                                                                                 1225 non-null   object 
 37  if you have a mental health disorder, how often do you feel that it interferes with your work when being treated effectively?                                                                                                   1225 non-null   object 
 38  if you have a mental health disorder, how often do you feel that it interferes with your work when not being treated effectively (i.e., when you are experiencing symptoms)?                                                    1225 non-null   object 
 39  have your observations of how another individual who discussed a mental health issue made you less likely to reveal a mental health issue yourself in your current workplace?                                                   1225 non-null   object 
 40  how willing would you be to share with friends and family that you have a mental illness?                                                                                                                                       1225 non-null   int64  
 41  would you be willing to bring up a physical health issue with a potential employer in an interview?                                                                                                                             1225 non-null   object 
 42  would you bring up your mental health with a potential employer in an interview?                                                                                                                                                1225 non-null   object 
 43  are you openly identified at work as a person with a mental health issue?                                                                                                                                                       1225 non-null   float64
 44  if they knew you suffered from a mental health disorder, how do you think that team members/co-workers would react?                                                                                                             1225 non-null   float64
 45  have you observed or experienced an unsupportive or badly handled response to a mental health issue in your current or previous workplace?                                                                                      1225 non-null   object 
 46  have you observed or experienced supportive or well handled response to a mental health issue in your current or previous workplace?                                                                                            1225 non-null   object 
 47  overall, how well do you think the tech industry supports employees with mental health issues?                                                                                                                                  1225 non-null   float64
 48  would you be willing to talk to one of us more extensively about your experiences with mental health issues in the tech industry? (note that all interview responses would be used anonymously and only with your permission.)  1225 non-null   float64
 49  what is your age?                                                                                                                                                                                                               1225 non-null   float64
 50  what is your gender?                                                                                                                                                                                                            1225 non-null   object 
 51  what country do you live in?                                                                                                                                                                                                    1225 non-null   object 
 52  what is your race?                                                                                                                                                                                                              1225 non-null   object 
 53  what country do you work in?                                                                                                                                                                                                    1225 non-null   object 
 54  year                                                                                                                                                                                                                            1225 non-null   int64  
dtypes: float64(18), int64(5), object(32)
memory usage: 526.5+ KB
</pre></div>
</div>
</div>
</div>
<p>Looking at the information of dataframe, there are quite a lot of fetuares which has data type as “object”. It is not necessary that all the features with data type as “object” be categorical features. There may be certain columns which might binary values which can be represented by booleans. It is better to check column one by one.<br />
But for now, I would like to go with the assumption that all the columns with data type as “object” are categorical columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
</div>
<p>There are 32 columns out of 55 which are categorical in nature. Out of those, after examining the data manually, we can infer that one of them is ordinal in nature and others can be treated as nominal columns. The column - “how many employees does your company or organization have?” - which gives information regarding the size of the company can be treated as ordinal coulmn.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encoding ordinal column for training data</span>
<span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;how many employees does your company or organization have?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;how many employees does your company or organization have?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;1-5&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;6-25&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;26-100&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;100-500&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                                                                                                                              <span class="s1">&#39;500-1000&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                                                                                                                                              <span class="s1">&#39;More than 1000&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>

<span class="c1"># Encoding ordinal column for testing data</span>
<span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;how many employees does your company or organization have?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;how many employees does your company or organization have?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;1-5&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;6-25&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;26-100&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> 
                                                                                                                                              <span class="s1">&#39;100-500&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                                                                                                                                              <span class="s1">&#39;500-1000&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                                                                                                                                              <span class="s1">&#39;More than 1000&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-8-d59b31438a42&gt;:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  X_train[&#39;how many employees does your company or organization have?&#39;] = X_train[&#39;how many employees does your company or organization have?&#39;].replace({&#39;1-5&#39;:1,
&lt;ipython-input-8-d59b31438a42&gt;:10: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  X_test[&#39;how many employees does your company or organization have?&#39;] = X_test[&#39;how many employees does your company or organization have?&#39;].replace({&#39;1-5&#39;:1,
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encoding nominal columns for training data</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">cat_cols</span><span class="p">:</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">dummy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
<span class="c1"># Encoding nominal columns for testing data</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">cat_cols</span><span class="p">:</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_test</span><span class="p">,</span> <span class="n">dummy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fill value 0 for mismatched columns</span>
<span class="n">mis_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">mis_cols</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="imbalance-check">
<h3>Imbalance check<a class="headerlink" href="#imbalance-check" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1    779
0    446
Name: have you ever sought treatment for a mental health disorder from a mental health professional?, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The data is imbalanced. In order to use any of the machine learning algorithm, we need to either over the minority class or downsample the majority. Considering the fact that we have less number of records in the data set, it is better to oversample. But, only training data needs to be oversample.<br />
For oversampling, Sample Minority Oversampling Technique (SMOTE) will be used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Oversample the minority class in the target variable</span>
<span class="n">oversample</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">oversample</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-training">
<h3>Model training<a class="headerlink" href="#model-training" title="Permalink to this headline">¶</a></h3>
<p>There are various paramters which random forest algorithm uses to train the model. Our aim is to find those paramters, also known as hyperparamters, which yeilds us the model with the best fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Declare parameters for grid search</span>

<span class="c1"># Declare the classifer</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Declare the paramter grid for searching</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">n_estimators</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gini&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">],</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">max_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">max_samples</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train the model</span>
<span class="n">rf_clf</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">rf_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 216 candidates, totalling 1080 fits
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GridSearchCV(cv=5,
             estimator=RandomForestClassifier(class_weight=&#39;balanced&#39;,
                                              oob_score=True),
             n_jobs=7,
             param_grid={&#39;criterion&#39;: [&#39;gini&#39;, &#39;entropy&#39;],
                         &#39;max_depth&#39;: [10, 20, 40, None],
                         &#39;max_features&#39;: [&#39;sqrt&#39;, &#39;log2&#39;, None],
                         &#39;max_samples&#39;: [0.4, 0.8, None],
                         &#39;n_estimators&#39;: [100, 200, 400]},
             scoring=&#39;f1&#39;, verbose=2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_clf</span><span class="o">.</span><span class="n">best_estimator_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier(class_weight=&#39;balanced&#39;, criterion=&#39;entropy&#39;,
                       max_depth=10, max_features=&#39;sqrt&#39;, max_samples=0.8,
                       oob_score=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save and load the model if required</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="c1"># joblib.dump(rf_clf.best_estimator_, &#39;./../../../models/rf_clf.pkl&#39;)</span>
<span class="n">rf_clf</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./../../../models/rf_clf.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict outcomes with test set</span>
<span class="c1"># y_pred = rf_clf.best_estimator_.predict(X_test)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">rf_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-evaluation">
<h3>Model Evaluation<a class="headerlink" href="#model-evaluation" title="Permalink to this headline">¶</a></h3>
<p>In order to compute sensitivity and specificity, we need values such as true positives, true negatives, false positives and false neagatives. These values can be easily obtained from confusion matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get values from confusion metrix</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute sensitivity</span>
<span class="n">sensitivity</span> <span class="o">=</span> <span class="n">tp</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">fn</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sensitivity: </span><span class="si">{</span><span class="n">sensitivity</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Compute specificity</span>
<span class="n">specificity</span> <span class="o">=</span> <span class="n">tn</span><span class="o">/</span><span class="p">(</span><span class="n">tn</span><span class="o">+</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specificity: </span><span class="si">{</span><span class="n">specificity</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Compute f1 score </span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 score: </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compute classicfication report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sensitivity: 0.8662420382165605 

Specificity: 0.8068181818181818 

F1 score: 0.8774193548387097 

              precision    recall  f1-score   support

           0       0.77      0.81      0.79        88
           1       0.89      0.87      0.88       157

    accuracy                           0.84       245
   macro avg       0.83      0.84      0.83       245
weighted avg       0.85      0.84      0.85       245
</pre></div>
</div>
</div>
</div>
<p>From the above report, it can inferred that model is finding it difficult to predict people who need to seek help from mental health professional and that can be acceptable. It won’t harm any of us to visit a mental health professional even if we need not seek any help for any mental health issue. On the other hand the model is quite good at telling in case we that much needed help from mental health professional. An average F1 score of 0.83 and the overall F1 score of 0.88 is quite good considering the amount of data that we are training with. Though the model is quite better in predicting the individuals who need help than the ones who do not, the values of specificity and sensitivity are not far apart and hence the overall performance of the model is laudable.</p>
</section>
<section id="fairness-evaluation">
<h3>Fairness evaluation<a class="headerlink" href="#fairness-evaluation" title="Permalink to this headline">¶</a></h3>
<p>There are certain sensitive columns present in the data for which model should be less likely to be biased. Following are the columns for which we will be expecting that model be fair as much as possible:</p>
<ol class="simple">
<li><p>Feature revealing gender of the participant (‘what is your gender?’)</p></li>
<li><p>Feature revealing race of the participant (‘what is your race?’)</p></li>
</ol>
<section id="disparity-check-with-respect-to-gender">
<h4>Disparity check with respect to gender<a class="headerlink" href="#disparity-check-with-respect-to-gender" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create fairness metrics with respect to gender</span>
<span class="n">fair_metrics_sex</span> <span class="o">=</span> <span class="n">MetricFrame</span><span class="p">({</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">},</span>
                          <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">X_test_ori</span><span class="p">[</span><span class="s1">&#39;what is your gender?&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display overall metrics</span>
<span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f1           0.877419
precision    0.888889
recall       0.866242
dtype: object
</pre></div>
</div>
</div>
</div>
<p>The overall metrics remains the same as the ungrouped metrics metrics that are calculated above. The overall precision and recall are close enough, indicating that the most of the people selected by the model for seeking help for mental health issues are relevant and also the most of the relevant people are picked by the model. Though obviously, there is huge scope for model improvement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display metrcis by group</span>
<span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">by_group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>f1</th>
      <th>precision</th>
      <th>recall</th>
    </tr>
    <tr>
      <th>what is your gender?</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>0.900901</td>
      <td>0.925926</td>
      <td>0.877193</td>
    </tr>
    <tr>
      <th>male</th>
      <td>0.864865</td>
      <td>0.869565</td>
      <td>0.860215</td>
    </tr>
    <tr>
      <th>other</th>
      <td>0.857143</td>
      <td>0.857143</td>
      <td>0.857143</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Model is finding it easier to tag more female candidates who need help than the other counterparts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;between_groups&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">])</span>
<span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
<span class="n">diff_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Difference</th>
      <th>Percentage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>f1</th>
      <td>0.043758</td>
      <td>4.375804</td>
    </tr>
    <tr>
      <th>precision</th>
      <td>0.068783</td>
      <td>6.878307</td>
    </tr>
    <tr>
      <th>recall</th>
      <td>0.02005</td>
      <td>2.005013</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>On a positive note, the difference between the minimum and the maximum metric is not huge</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create fairness metrics</span>
<span class="n">fair_metrics_race</span> <span class="o">=</span> <span class="n">MetricFrame</span><span class="p">({</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">},</span>
                          <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">X_test_ori</span><span class="p">[</span><span class="s1">&#39;what is your race?&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display overall metrics</span>
<span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f1           0.877419
precision    0.888889
recall       0.866242
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display metrcis by group</span>
<span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">by_group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>f1</th>
      <th>precision</th>
      <th>recall</th>
    </tr>
    <tr>
      <th>what is your race?</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Asian</th>
      <td>0.666667</td>
      <td>0.666667</td>
      <td>0.666667</td>
    </tr>
    <tr>
      <th>Black or African American</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>I prefer not to answer</th>
      <td>0.764706</td>
      <td>0.764706</td>
      <td>0.764706</td>
    </tr>
    <tr>
      <th>More than one of the above</th>
      <td>0.8</td>
      <td>1.0</td>
      <td>0.666667</td>
    </tr>
    <tr>
      <th>White</th>
      <td>0.917031</td>
      <td>0.929204</td>
      <td>0.905172</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The model is working perfectly for black or African Americans but working the worst for asian participants. Moreover, for people belongs to more than one race, people selected by the model for help are all relevant but it could not identify all the those who are relevant. For white participants, model is working quite good and the disparity differences with the highest expected value is quite less.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;between_groups&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">])</span>
<span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
<span class="n">diff_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Difference</th>
      <th>Percentage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>f1</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
    <tr>
      <th>precision</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
    <tr>
      <th>recall</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The disparity between the scores are huge and it should be mitigated.</p>
</section>
</section>
<section id="mitigated-model-training">
<h3>Mitigated Model Training<a class="headerlink" href="#mitigated-model-training" title="Permalink to this headline">¶</a></h3>
<p>Here we will be utilizing the best estimator that we trained using grid search.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Declare paramters for mitigated model training</span>
<span class="n">best_estimator</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;entropy&#39;</span><span class="p">,</span> 
                                        <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> 
                                        <span class="n">max_samples</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">constraint</span> <span class="o">=</span> <span class="n">TruePositiveRateParity</span><span class="p">(</span><span class="n">difference_bound</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>

<span class="n">X_train_rc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">sensitive_features_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;what is your gender?&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;what is your race?&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_sf</span> <span class="o">=</span> <span class="n">X_train_rc</span><span class="p">[</span><span class="n">sensitive_features_columns</span><span class="p">]</span>
<span class="n">X_train_rc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">sensitive_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train the model</span>
<span class="n">mitigator</span> <span class="o">=</span> <span class="n">GridSearch</span><span class="p">(</span><span class="n">best_estimator</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mitigator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_rc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">X_train_sf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Logging error ---
Traceback (most recent call last):
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 1081, in emit
    msg = self.format(record)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 925, in format
    return fmt.format(record)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 664, in format
    record.message = record.getMessage()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 369, in getMessage
    msg = msg % self.args
TypeError: not all arguments converted during string formatting
Call stack:
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/runpy.py&quot;, line 194, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/runpy.py&quot;, line 87, in _run_code
    exec(code, run_globals)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel_launcher.py&quot;, line 16, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/traitlets/config/application.py&quot;, line 845, in launch_instance
    app.start()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelapp.py&quot;, line 612, in start
    self.io_loop.start()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/platform/asyncio.py&quot;, line 199, in start
    self.asyncio_loop.run_forever()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/base_events.py&quot;, line 570, in run_forever
    self._run_once()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/base_events.py&quot;, line 1859, in _run_once
    handle._run()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/events.py&quot;, line 81, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/ioloop.py&quot;, line 688, in &lt;lambda&gt;
    lambda f: self._run_callback(functools.partial(callback, future))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/ioloop.py&quot;, line 741, in _run_callback
    ret = callback()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 814, in inner
    self.ctx_run(self.run)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 775, in run
    yielded = self.gen.send(value)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 358, in process_one
    yield gen.maybe_future(dispatch(*args))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 261, in dispatch_shell
    yield gen.maybe_future(handler(stream, idents, msg))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 536, in execute_request
    self.do_execute(
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/ipkernel.py&quot;, line 302, in do_execute
    res = shell.run_cell(code, store_history=store_history, silent=silent)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/zmqshell.py&quot;, line 539, in run_cell
    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 2866, in run_cell
    result = self._run_cell(
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 2895, in _run_cell
    return runner(coro)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/async_helpers.py&quot;, line 68, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3071, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3263, in run_ast_nodes
    if (await self.run_code(code, result,  async_=asy)):
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3343, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;&lt;ipython-input-212-a786ba150a1e&gt;&quot;, line 1, in &lt;module&gt;
    mitigator.fit(X_train_rc, y_train, sensitive_features=X_train_sf)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/fairlearn/reductions/_grid_search/grid_search.py&quot;, line 142, in fit
    grid = _GridGenerator(self.grid_size,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/fairlearn/reductions/_grid_search/_grid_generator.py&quot;, line 61, in __init__
    logger.warning(GRID_DIMENSION_WARN_TEMPLATE, true_dim, GRID_DIMENSION_WARN_THRESHOLD)
Message: &#39;The grid has {} dimensions. It is not recommended to use more than {}, otherwise a prohibitively large grid size is required to explore the space thoroughly. For such cases consider using ExponentiatedGradient from the fairlearn.reductions module.&#39;
Arguments: (231, 4)
--- Logging error ---
Traceback (most recent call last):
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 1081, in emit
    msg = self.format(record)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 925, in format
    return fmt.format(record)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 664, in format
    record.message = record.getMessage()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/logging/__init__.py&quot;, line 369, in getMessage
    msg = msg % self.args
TypeError: not all arguments converted during string formatting
Call stack:
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/runpy.py&quot;, line 194, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/runpy.py&quot;, line 87, in _run_code
    exec(code, run_globals)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel_launcher.py&quot;, line 16, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/traitlets/config/application.py&quot;, line 845, in launch_instance
    app.start()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelapp.py&quot;, line 612, in start
    self.io_loop.start()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/platform/asyncio.py&quot;, line 199, in start
    self.asyncio_loop.run_forever()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/base_events.py&quot;, line 570, in run_forever
    self._run_once()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/base_events.py&quot;, line 1859, in _run_once
    handle._run()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/asyncio/events.py&quot;, line 81, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/ioloop.py&quot;, line 688, in &lt;lambda&gt;
    lambda f: self._run_callback(functools.partial(callback, future))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/ioloop.py&quot;, line 741, in _run_callback
    ret = callback()
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 814, in inner
    self.ctx_run(self.run)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 775, in run
    yielded = self.gen.send(value)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 358, in process_one
    yield gen.maybe_future(dispatch(*args))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 261, in dispatch_shell
    yield gen.maybe_future(handler(stream, idents, msg))
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/kernelbase.py&quot;, line 536, in execute_request
    self.do_execute(
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/tornado/gen.py&quot;, line 234, in wrapper
    yielded = ctx_run(next, result)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/ipkernel.py&quot;, line 302, in do_execute
    res = shell.run_cell(code, store_history=store_history, silent=silent)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/ipykernel/zmqshell.py&quot;, line 539, in run_cell
    return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 2866, in run_cell
    result = self._run_cell(
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 2895, in _run_cell
    return runner(coro)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/async_helpers.py&quot;, line 68, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3071, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3263, in run_ast_nodes
    if (await self.run_code(code, result,  async_=asy)):
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/IPython/core/interactiveshell.py&quot;, line 3343, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;&lt;ipython-input-212-a786ba150a1e&gt;&quot;, line 1, in &lt;module&gt;
    mitigator.fit(X_train_rc, y_train, sensitive_features=X_train_sf)
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/fairlearn/reductions/_grid_search/grid_search.py&quot;, line 142, in fit
    grid = _GridGenerator(self.grid_size,
  File &quot;/Users/pushkar/miniconda3/envs/mh/lib/python3.8/site-packages/fairlearn/reductions/_grid_search/_grid_generator.py&quot;, line 65, in __init__
    logger.warning(GRID_SIZE_WARN_TEMPLATE, grid_size, recommended_min_grid_size)
Message: &#39;Generating a grid with {} grid points. It is recommended to use at least {} grid points. Please consider increasing grid_size.&#39;
Arguments: (100, 3450873173395281893717377931138512726225554486085193277581262111899648)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save and load the model if required</span>
<span class="c1"># import joblib</span>
<span class="c1"># joblib.dump(mitigator, &#39;./../../../models/mitigated_rf_clf.pkl&#39;)</span>
<span class="c1"># mitigated_rf = joblib.load(&#39;./../../../models/mitigated_rf_clf.pkl&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_rc</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">sensitive_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred_mitigated</span> <span class="o">=</span> <span class="n">mitigator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_rc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mitigated-model-evaluation">
<h3>Mitigated Model Evaluation<a class="headerlink" href="#mitigated-model-evaluation" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get values from confusion metrix</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_mitigated</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute sensitivity</span>
<span class="n">sensitivity</span> <span class="o">=</span> <span class="n">tp</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">fn</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sensitivity: </span><span class="si">{</span><span class="n">sensitivity</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Compute specificity</span>
<span class="n">specificity</span> <span class="o">=</span> <span class="n">tn</span><span class="o">/</span><span class="p">(</span><span class="n">tn</span><span class="o">+</span><span class="n">fp</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specificity: </span><span class="si">{</span><span class="n">specificity</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># Compute f1 score </span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 score: </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compute classicfication report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_mitigated</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sensitivity: 0.8535031847133758 

Specificity: 0.8068181818181818 

F1 score: 0.8774193548387097 

              precision    recall  f1-score   support

           0       0.76      0.81      0.78        88
           1       0.89      0.85      0.87       157

    accuracy                           0.84       245
   macro avg       0.82      0.83      0.83       245
weighted avg       0.84      0.84      0.84       245
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create fairness metrics with respect to gender</span>
<span class="n">fair_metrics_sex</span> <span class="o">=</span> <span class="n">MetricFrame</span><span class="p">({</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">},</span>
                          <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_mitigated</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">X_test_ori</span><span class="p">[</span><span class="s1">&#39;what is your gender?&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display overall metrics</span>
<span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f1            0.87013
precision    0.887417
recall       0.853503
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display metrcis by group</span>
<span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">by_group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>f1</th>
      <th>precision</th>
      <th>recall</th>
    </tr>
    <tr>
      <th>what is your gender?</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>0.899083</td>
      <td>0.942308</td>
      <td>0.859649</td>
    </tr>
    <tr>
      <th>male</th>
      <td>0.854054</td>
      <td>0.858696</td>
      <td>0.849462</td>
    </tr>
    <tr>
      <th>other</th>
      <td>0.857143</td>
      <td>0.857143</td>
      <td>0.857143</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fair_metrics_sex</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;between_groups&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">])</span>
<span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
<span class="n">diff_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Difference</th>
      <th>Percentage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>f1</th>
      <td>0.045029</td>
      <td>4.502851</td>
    </tr>
    <tr>
      <th>precision</th>
      <td>0.085165</td>
      <td>8.516484</td>
    </tr>
    <tr>
      <th>recall</th>
      <td>0.010187</td>
      <td>1.018676</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create fairness metrics</span>
<span class="n">fair_metrics_race</span> <span class="o">=</span> <span class="n">MetricFrame</span><span class="p">({</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">},</span>
                          <span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_mitigated</span><span class="p">,</span> <span class="n">sensitive_features</span><span class="o">=</span><span class="n">X_test_ori</span><span class="p">[</span><span class="s1">&#39;what is your race?&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display overall metrics</span>
<span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">overall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f1            0.87013
precision    0.887417
recall       0.853503
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display metrcis by group</span>
<span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">by_group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>f1</th>
      <th>precision</th>
      <th>recall</th>
    </tr>
    <tr>
      <th>what is your race?</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Asian</th>
      <td>0.666667</td>
      <td>0.666667</td>
      <td>0.666667</td>
    </tr>
    <tr>
      <th>Black or African American</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>I prefer not to answer</th>
      <td>0.757576</td>
      <td>0.78125</td>
      <td>0.735294</td>
    </tr>
    <tr>
      <th>More than one of the above</th>
      <td>0.8</td>
      <td>1.0</td>
      <td>0.666667</td>
    </tr>
    <tr>
      <th>White</th>
      <td>0.908297</td>
      <td>0.920354</td>
      <td>0.896552</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fair_metrics_race</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;between_groups&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">])</span>
<span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_metrics</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
<span class="n">diff_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Difference</th>
      <th>Percentage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>f1</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
    <tr>
      <th>precision</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
    <tr>
      <th>recall</th>
      <td>0.333333</td>
      <td>33.333333</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs/models"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="models.html" title="previous page">Data Modelling</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Pushkar Patil<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>